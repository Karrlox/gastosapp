<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Gastos e Ingresos para Inmobiliaria FabricandoHogares</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        input, select, button, textarea {
            border-radius: 0.5rem; /* rounded-md */
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.5rem 1rem;
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-secondary {
            background-color: #6b7280; /* gray-500 */
            color: white;
            padding: 0.5rem 1rem;
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .btn-gemini {
            background-color: #f97316; /* orange-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-gemini:hover {
            background-color: #ea580c; /* orange-600 */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 600px;
            text-align: center;
            position: relative; /* For close button positioning */
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles for bar chart */
        .bar-chart-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .bar-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .bar-label {
            width: 120px; /* Fixed width for labels */
            text-align: right;
            font-size: 0.875rem; /* text-sm */
            flex-shrink: 0;
        }
        .bar-fill {
            background-color: #ef4444; /* red-500 */
            height: 20px;
            border-radius: 0.25rem;
            transition: width 0.5s ease-in-out;
        }
        .bar-value {
            font-size: 0.875rem; /* text-sm */
            font-weight: 600; /* font-semibold */
            flex-shrink: 0;
        }
        /* Budgeting styles */
        .budget-bar-container {
            width: 100%;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.5rem;
            height: 20px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .budget-bar-fill {
            height: 100%;
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
            background-color: #22c55e; /* green-500 */
        }
        .budget-bar-fill.over-budget {
            background-color: #ef4444; /* red-500 */
        }
        .budget-text {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }


        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .card {
                padding: 1.5rem;
            }
            .grid-cols-1\/2 {
                grid-template-columns: 1fr;
            }
            .md\\:col-span-2 {
                grid-column: span 1 / span 1; /* Override for mobile */
            }
            .bar-label {
                width: 80px; /* Adjust for smaller screens */
            }
        }
    </style>
</head>
<body>
    <div id="authSection" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
            <h2 id="authTitle" class="text-3xl font-bold text-center text-indigo-700 mb-6">Iniciar Sesión</h2>
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="authEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="authEmail" placeholder="tu@email.com" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="authPassword" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="authPassword" placeholder="********" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" id="authSubmitBtn" class="btn-primary w-full">Iniciar Sesión</button>
            </form>
            <p id="authMessage" class="text-center text-sm mt-4 hidden"></p>
            <div class="text-center mt-4">
                <button id="toggleAuthModeBtn" class="text-indigo-600 hover:text-indigo-800 text-sm">¿No tienes cuenta? Regístrate aquí</button>
            </div>
        </div>
    </div>

    <div id="mainAppContent" class="container flex-grow hidden">
        <h1 class="text-4xl font-bold text-center text-indigo-700 mb-8 mt-4">Gestor de Gastos e Ingresos para Inmobiliaria FabricandoHogares</h1>

        <div class="card mb-6 p-4 text-center flex justify-between items-center flex-wrap">
            <p class="text-sm text-gray-600">ID de Usuario: <span id="userIdDisplay" class="font-mono text-gray-800 break-all">Cargando...</span></p>
            <button id="logoutBtn" class="btn-danger px-4 py-2 text-sm mt-2 sm:mt-0">Cerrar Sesión</button>
        </div>

        <div class="card mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Resumen Financiero</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-lg font-medium text-blue-800">Total Ingresos:</p>
                    <p id="totalIncome" class="text-3xl font-bold text-blue-700 mt-2">€0.00</p>
                </div>
                <div class="bg-red-50 p-4 rounded-lg">
                    <p class="text-lg font-medium text-red-800">Total Gastos:</p>
                    <p id="totalExpenses" class="text-3xl font-bold text-red-700 mt-2">€0.00</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-lg font-medium text-green-700 mt-2">Balance:</p>
                    <p id="balance" class="text-3xl font-bold text-green-700 mt-2">€0.00</p>
                </div>
            </div>
            <div class="flex justify-center flex-wrap gap-4">
                <button id="analyzeExpensesBtn" class="btn-gemini">
                    <span id="analyzeSpinner" class="spinner hidden"></span>
                    Generar Análisis de Gastos ✨
                </button>
                <button id="showCategoryAnalysisBtn" class="btn-secondary">Análisis por Categoría</button>
                <button id="showMonthlyAnalysisBtn" class="btn-secondary">Análisis Mensual</button>
            </div>
        </div>

        <div class="card mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Próximos Pagos/Cobros (7 días)</h2>
            <div id="upcomingItemsList" class="space-y-3">
                <p class="text-gray-500 text-center" id="noUpcomingMessage">No hay pagos o cobros próximos.</p>
            </div>
        </div>

        <div class="flex justify-center mb-6">
            <button id="tabTransactions" class="px-6 py-3 font-semibold text-lg rounded-t-lg bg-indigo-600 text-white shadow-md transition-colors duration-200">Transacciones</button>
            <button id="tabProjects" class="px-6 py-3 font-semibold text-lg rounded-t-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors duration-200">Proyectos/Propiedades</button>
            <button id="tabBudgets" class="px-6 py-3 font-semibold text-lg rounded-t-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors duration-200">Presupuestos</button>
        </div>

        <div id="transactionsSection" class="card">
            <div class="flex justify-center mb-6">
                <button id="subTabExpenses" class="px-6 py-3 font-semibold text-lg rounded-t-lg bg-indigo-600 text-white shadow-md transition-colors duration-200">Gastos</button>
                <button id="subTabIncome" class="px-6 py-3 font-semibold text-lg rounded-t-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors duration-200">Ingresos</button>
            </div>

            <div id="expenseContent" class="">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Añadir Nuevo Gasto</h2>
                <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="expenseDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                        <div class="flex gap-2">
                            <input type="text" id="expenseDescription" placeholder="Material de oficina, Alquiler, etc." required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                            <button type="button" id="suggestCategoryBtn" class="btn-gemini text-sm px-4 py-2 mt-1">
                                <span id="suggestSpinner" class="spinner hidden"></span>
                                Sugerir Categoría ✨
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="expenseAmount" class="block text-sm font-medium text-gray-700 mb-1">Importe (€)</label>
                        <input type="number" id="expenseAmount" step="0.01" placeholder="Ej: 150.75" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="expenseDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="expenseDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="expenseCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                        <select id="expenseCategory" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">Selecciona una categoría</option>
                            <option value="Material de Oficina">Material de Oficina</option>
                            <option value="Suministros">Suministros</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Comidas">Comidas</option>
                            <option value="Alquiler">Alquiler</option>
                            <option value="Servicios Profesionales">Servicios Profesionales</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Software/Suscripciones">Software/Suscripciones</option>
                            <option value="Comisiones">Comisiones</option>
                            <option value="Reformas/Mantenimiento">Reformas/Mantenimiento</option>
                            <option value="Impuestos Propiedad">Impuestos Propiedad</option>
                            <option value="Seguros Inmobiliarios">Seguros Inmobiliarios</option>
                            <option value="Publicidad Inmobiliaria">Publicidad Inmobiliaria</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div>
                        <label for="expenseFrequency" class="block text-sm font-medium text-gray-700 mb-1">Frecuencia</label>
                        <select id="expenseFrequency" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="Momentáneo">Momentáneo</option>
                            <option value="Semanal">Semanal</option>
                            <option value="Mensual">Mensual</option>
                            <option value="Anual">Anual</option>
                        </select>
                    </div>
                    <div>
                        <label for="expenseProject" class="block text-sm font-medium text-gray-700 mb-1">Proyecto/Propiedad</label>
                        <select id="expenseProject" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">Ninguno</option>
                            </select>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="btn-primary w-full md:w-auto">Añadir Gasto</button>
                    </div>
                </form>

                <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8">Lista de Gastos</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="filterExpenseCategory" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Categoría</label>
                        <select id="filterExpenseCategory" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">Todas las categorías</option>
                            <option value="Material de Oficina">Material de Oficina</option>
                            <option value="Suministros">Suministros</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Comidas">Comidas</option>
                            <option value="Alquiler">Alquiler</option>
                            <option value="Servicios Profesionales">Servicios Profesionales</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Software/Suscripciones">Software/Suscripciones</option>
                            <option value="Comisiones">Comisiones</option>
                            <option value="Reformas/Mantenimiento">Reformas/Mantenimiento</option>
                            <option value="Impuestos Propiedad">Impuestos Propiedad</option>
                            <option value="Seguros Inmobiliarios">Seguros Inmobiliarios</option>
                            <option value="Publicidad Inmobiliaria">Publicidad Inmobiliaria</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterExpenseDate" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Fecha</label>
                        <input type="date" id="filterExpenseDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="searchExpense" class="block text-sm font-medium text-gray-700 mb-1">Buscar Gasto</label>
                        <input type="text" id="searchExpense" placeholder="Buscar por descripción..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div id="expensesList" class="space-y-4">
                    <p class="text-gray-500 text-center" id="noExpensesMessage">No hay gastos registrados aún.</p>
                </div>
            </div>

            <div id="incomeContent" class="hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Añadir Nuevo Ingreso</h2>
                <form id="incomeForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="incomeDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                        <input type="text" id="incomeDescription" placeholder="Venta de propiedad, Comisión, Alquiler, etc." required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="incomeAmount" class="block text-sm font-medium text-gray-700 mb-1">Importe (€)</label>
                        <input type="number" id="incomeAmount" step="0.01" placeholder="Ej: 500.00" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="incomeDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="incomeDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="incomeCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                        <select id="incomeCategory" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">Selecciona una categoría</option>
                            <option value="Ventas de Propiedades">Ventas de Propiedades</option>
                            <option value="Alquileres">Alquileres</option>
                            <option value="Comisiones Ventas">Comisiones Ventas</option>
                            <option value="Comisiones Alquiler">Comisiones Alquiler</option>
                            <option value="Servicios de Gestión">Servicios de Gestión</option>
                            <option value="Otros Ingresos Inmobiliarios">Otros Ingresos Inmobiliarios</option>
                        </select>
                    </div>
                    <div>
                        <label for="incomeFrequency" class="block text-sm font-medium text-gray-700 mb-1">Frecuencia</label>
                        <select id="incomeFrequency" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="Momentáneo">Momentáneo</option>
                            <option value="Semanal">Semanal</option>
                            <option value="Mensual">Mensual</option>
                            <option value="Anual">Anual</option>
                        </select>
                    </div>
                    <div>
                        <label for="incomeProject" class="block text-sm font-medium text-gray-700 mb-1">Proyecto/Propiedad</label>
                        <select id="incomeProject" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">Ninguno</option>
                            </select>
                    </div>
                    <div class="md:col-span-2 flex justify-end">
                        <button type="submit" class="btn-primary w-full md:w-auto">Añadir Ingreso</button>
                    </div>
                </form>

                <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8">Lista de Ingresos</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="filterIncomeCategory" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Categoría</label>
                        <select id="filterIncomeCategory" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">Todas las categorías</option>
                            <option value="Ventas de Propiedades">Ventas de Propiedades</option>
                            <option value="Alquileres">Alquileres</option>
                            <option value="Comisiones Ventas">Comisiones Ventas</option>
                            <option value="Comisiones Alquiler">Comisiones Alquiler</option>
                            <option value="Servicios de Gestión">Servicios de Gestión</option>
                            <option value="Otros Ingresos Inmobiliarios">Otros Ingresos Inmobiliarios</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterIncomeDate" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Fecha</label>
                        <input type="date" id="filterIncomeDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="searchIncome" class="block text-sm font-medium text-gray-700 mb-1">Buscar Ingreso</label>
                        <input type="text" id="searchIncome" placeholder="Buscar por descripción..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div id="incomeList" class="space-y-4">
                    <p class="text-gray-500 text-center" id="noIncomeMessage">No hay ingresos registrados aún.</p>
                </div>
            </div>
        </div>

        <div id="projectsSection" class="card hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Gestión de Proyectos/Propiedades</h2>
            <form id="projectForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="projectName" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proyecto/Propiedad</label>
                    <input type="text" id="projectName" placeholder="Ej: Piso Calle Mayor 15" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="projectBudget" class="block text-sm font-medium text-gray-700 mb-1">Presupuesto Estimado (€)</label>
                    <input type="number" id="projectBudget" step="0.01" placeholder="Ej: 150000" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="btn-primary w-full md:w-auto">Añadir Proyecto</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold text-gray-800 mb-4">Lista de Proyectos/Propiedades</h3>
            <div id="projectsList" class="space-y-4">
                <p class="text-gray-500 text-center" id="noProjectsMessage">No hay proyectos/propiedades registrados aún.</p>
                </div>
        </div>

        <div id="budgetsSection" class="card hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Presupuestos por Categoría (Mensual)</h2>
            <p class="text-gray-600 mb-4">Establece un presupuesto mensual para cada categoría de gasto. El progreso se basa en los gastos del **mes actual**.</p>

            <form id="budgetForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label for="budgetCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                    <select id="budgetCategory" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="">Selecciona una categoría</option>
                        <option value="Material de Oficina">Material de Oficina</option>
                        <option value="Suministros">Suministros</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Comidas">Comidas</option>
                        <option value="Alquiler">Alquiler</option>
                        <option value="Servicios Profesionales">Servicios Profesionales</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Software/Suscripciones">Software/Suscripciones</option>
                        <option value="Comisiones">Comisiones</option>
                        <option value="Reformas/Mantenimiento">Reformas/Mantenimiento</option>
                        <option value="Impuestos Propiedad">Impuestos Propiedad</option>
                        <option value="Seguros Inmobiliarios">Seguros Inmobiliarios</option>
                        <option value="Publicidad Inmobiliaria">Publicidad Inmobiliaria</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div>
                    <label for="budgetAmount" class="block text-sm font-medium text-gray-700 mb-1">Presupuesto Mensual (€)</label>
                    <input type="number" id="budgetAmount" step="0.01" placeholder="Ej: 500" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="btn-primary w-full md:w-auto">Guardar Presupuesto</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold text-gray-800 mb-4">Tus Presupuestos</h3>
            <div id="budgetsList" class="space-y-6">
                <p class="text-gray-500 text-center" id="noBudgetsMessage">No hay presupuestos definidos aún.</p>
                </div>
        </div>

    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeConfirmationModal">&times;</span>
            <p class="text-lg font-semibold mb-4">¿Estás seguro de que quieres eliminar este elemento?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteBtn" class="btn-danger px-6 py-2">Sí, eliminar</button>
                <button id="cancelDeleteBtn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md font-semibold hover:bg-gray-400 transition-colors">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeEditModal">&times;</span>
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Editar Elemento</h2>
            <form id="editForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <input type="hidden" id="editId">
                <input type="hidden" id="editType">
                <div>
                    <label for="editDescription" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <input type="text" id="editDescription" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="editAmount" class="block text-sm font-medium text-gray-700 mb-1">Importe (€)</label>
                    <input type="number" id="editAmount" step="0.01" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="editDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                    <input type="date" id="editDate" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="editCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                    <select id="editCategory" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        </select>
                </div>
                <div>
                    <label for="editFrequency" class="block text-sm font-medium text-gray-700 mb-1">Frecuencia</label>
                    <select id="editFrequency" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="Momentáneo">Momentáneo</option>
                        <option value="Semanal">Semanal</option>
                        <option value="Mensual">Mensual</option>
                        <option value="Anual">Anual</option>
                    </select>
                </div>
                 <div>
                    <label for="editProject" class="block text-sm font-medium text-gray-700 mb-1">Proyecto/Propiedad</label>
                    <select id="editProject" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                        <option value="">Ninguno</option>
                        </select>
                </div>
                <div class="md:col-span-2 flex justify-end">
                    <button type="submit" class="btn-primary w-full md:w-auto">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAnalysisModal">&times;</span>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Análisis de Gastos ✨</h2>
            <div id="analysisContent" class="text-left text-gray-700 whitespace-pre-wrap">
                Cargando análisis...
            </div>
            <div class="mt-6 flex justify-center">
                <button id="closeAnalysisModalBtn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md font-semibold hover:bg-gray-400 transition-colors">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="categoryAnalysisModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCategoryAnalysisModal">&times;</span>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Análisis por Categoría</h2>
            <div id="categoryAnalysisContent" class="text-left text-gray-700">
                </div>
            <div class="mt-6 flex justify-center">
                <button id="closeCategoryAnalysisModalBtn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md font-semibold hover:bg-gray-400 transition-colors">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="monthlyAnalysisModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeMonthlyAnalysisModal">&times;</span>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Análisis Mensual</h2>
            <div id="monthlyAnalysisContent" class="text-left text-gray-700">
                </div>
            <div class="mt-6 flex justify-center">
                <button id="closeMonthlyAnalysisModalBtn" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md font-semibold hover:bg-gray-400 transition-colors">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js"; // Updated to 11.8.1
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js"; // Updated to 11.8.1
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js"; // Updated to 11.8.1
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js"; // Added analytics import

        // Global variables for Firebase
        let app;
        let db;
        let auth;
        let analytics; // Declare analytics variable
        let userId = null;

        // TU CONFIGURACIÓN REAL DE FIREBASE AQUÍ
        const firebaseConfig = {
            apiKey: "AIzaSyCDBg8qM50VpW59IBQ94ZhLceq2sCwf1rc",
            authDomain: "gastosinmobiliaria.firebaseapp.com",
            projectId: "gastosinmobiliaria",
            storageBucket: "gastosinmobiliaria.firebasestorage.app",
            messagingSenderId: "690296047200",
            appId: "1:690296047200:web:b37efc46d3ae0dfe03e505",
            measurementId: "G-GZTXT2VSM5"
        };

        // Usamos el projectId como appId para la ruta de Firestore, como ya está en el código
        const appId = firebaseConfig.projectId;

        // Gemini API Key (leave empty, Canvas will provide at runtime)
        const apiKey = ""; // Si quieres usar modelos diferentes, proporciona una clave API aquí. De lo contrario, déjalo así.

        // DOM Elements - Auth Section
        const authSection = document.getElementById('authSection');
        const mainAppContent = document.getElementById('mainAppContent');
        const authTitle = document.getElementById('authTitle');
        const authForm = document.getElementById('authForm');
        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authMessage = document.getElementById('authMessage');
        const toggleAuthModeBtn = document.getElementById('toggleAuthModeBtn');
        let isLoginMode = true; // State for login/register toggle

        // DOM Elements - Main App
        const userIdDisplay = document.getElementById('userIdDisplay');
        const logoutBtn = document.getElementById('logoutBtn');
        const expenseForm = document.getElementById('expenseForm');
        const incomeForm = document.getElementById('incomeForm');
        const expensesList = document.getElementById('expensesList');
        const incomeList = document.getElementById('incomeList');
        const totalExpensesDisplay = document.getElementById('totalExpenses');
        const totalIncomeDisplay = document.getElementById('totalIncome');
        const balanceDisplay = document.getElementById('balance');
        const noExpensesMessage = document.getElementById('noExpensesMessage');
        const noIncomeMessage = document.getElementById('noIncomeMessage');
        const upcomingItemsList = document.getElementById('upcomingItemsList');
        const noUpcomingMessage = document.getElementById('noUpcomingMessage');

        // Filter and Search elements
        const filterExpenseCategory = document.getElementById('filterExpenseCategory');
        const filterExpenseDate = document.getElementById('filterExpenseDate');
        const searchExpense = document.getElementById('searchExpense');
        const filterIncomeCategory = document.getElementById('filterIncomeCategory');
        const filterIncomeDate = document.getElementById('filterIncomeDate');
        const searchIncome = document.getElementById('searchIncome');

        // Main Tab elements
        const tabTransactions = document.getElementById('tabTransactions');
        const tabProjects = document.getElementById('tabProjects');
        const tabBudgets = document.getElementById('tabBudgets');
        const transactionsSection = document.getElementById('transactionsSection');
        const projectsSection = document.getElementById('projectsSection');
        const budgetsSection = document.getElementById('budgetsSection');

        // Sub-tab elements for Transactions
        const subTabExpenses = document.getElementById('subTabExpenses');
        const subTabIncome = document.getElementById('subTabIncome');
        const expenseContent = document.getElementById('expenseContent');
        const incomeContent = document.getElementById('incomeContent');

        // Modals
        const confirmationModal = document.getElementById('confirmationModal');
        const closeConfirmationModal = document.getElementById('closeConfirmationModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        const editModal = document.getElementById('editModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const editForm = document.getElementById('editForm');
        const editIdInput = document.getElementById('editId');
        const editTypeInput = document.getElementById('editType');
        const editDescriptionInput = document.getElementById('editDescription');
        const editAmountInput = document.getElementById('editAmount');
        const editDateInput = document.getElementById('editDate');
        const editCategorySelect = document.getElementById('editCategory');
        const editFrequencySelect = document.getElementById('editFrequency');
        const editProjectSelect = document.getElementById('editProject');


        const analysisModal = document.getElementById('analysisModal');
        const closeAnalysisModal = document.getElementById('closeAnalysisModal');
        const closeAnalysisModalBtn = document.getElementById('closeAnalysisModalBtn');
        const analysisContent = document.getElementById('analysisContent');

        const categoryAnalysisModal = document.getElementById('categoryAnalysisModal');
        const closeCategoryAnalysisModal = document.getElementById('closeCategoryAnalysisModal');
        const closeCategoryAnalysisModalBtn = document.getElementById('closeCategoryAnalysisModalBtn');
        const categoryAnalysisContent = document.getElementById('categoryAnalysisContent');

        const monthlyAnalysisModal = document.getElementById('monthlyAnalysisModal');
        const closeMonthlyAnalysisModal = document.getElementById('closeMonthlyAnalysisModal');
        const closeMonthlyAnalysisModalBtn = document.getElementById('closeMonthlyAnalysisModalBtn');
        const monthlyAnalysisContent = document.getElementById('monthlyAnalysisContent');

        // Gemini API related elements
        const suggestCategoryBtn = document.getElementById('suggestCategoryBtn');
        const expenseDescriptionInput = document.getElementById('expenseDescription');
        const expenseCategorySelect = document.getElementById('expenseCategory');
        const expenseFrequencySelect = document.getElementById('expenseFrequency');
        const expenseProjectSelect = document.getElementById('expenseProject');
        const suggestSpinner = document.getElementById('suggestSpinner');

        const analyzeExpensesBtn = document.getElementById('analyzeExpensesBtn');
        const analyzeSpinner = document.getElementById('analyzeSpinner');

        const incomeFrequencySelect = document.getElementById('incomeFrequency');
        const incomeProjectSelect = document.getElementById('incomeProject');

        const showCategoryAnalysisBtn = document.getElementById('showCategoryAnalysisBtn');
        const showMonthlyAnalysisBtn = document.getElementById('showMonthlyAnalysisBtn');

        // Project/Budget specific elements
        const projectForm = document.getElementById('projectForm');
        const projectNameInput = document.getElementById('projectName');
        const projectBudgetInput = document.getElementById('projectBudget');
        const projectsList = document.getElementById('projectsList');
        const noProjectsMessage = document.getElementById('noProjectsMessage');

        const budgetForm = document.getElementById('budgetForm');
        const budgetCategorySelect = document.getElementById('budgetCategory');
        const budgetAmountInput = document.getElementById('budgetAmount');
        const budgetsList = document.getElementById('budgetsList');
        const noBudgetsMessage = document.getElementById('noBudgetsMessage');


        let itemToDelete = null;
        let allExpenses = [];
        let allIncomes = [];
        let allProjects = [];
        let allBudgets = [];


        // --- Firebase Initialization and Authentication ---
        const initializeFirebase = async () => {
            try {
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    analytics = getAnalytics(app); // Initialize analytics
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in.
                        userId = user.uid;
                        userIdDisplay.textContent = user.email || user.uid; // Show email if available, else UID

                        // Hide auth section, show main app
                        authSection.classList.add('hidden');
                        mainAppContent.classList.remove('hidden');

                        // Start listening for data for the authenticated user
                        listenForExpenses();
                        listenForIncomes();
                        listenForProjects();
                        listenForBudgets();

                    } else {
                        // User is signed out.
                        userId = null;
                        userIdDisplay.textContent = 'No autenticado';

                        // Show auth section, hide main app
                        authSection.classList.remove('hidden');
                        mainAppContent.classList.add('hidden');

                        // Clear existing data from UI if user logs out
                        expensesList.innerHTML = '<p class="text-gray-500 text-center">Inicia sesión para ver tus gastos.</p>';
                        incomeList.innerHTML = '<p class="text-gray-500 text-center">Inicia sesión para ver tus ingresos.</p>';
                        projectsList.innerHTML = '<p class="text-gray-500 text-center">Inicia sesión para ver tus proyectos.</p>';
                        budgetsList.innerHTML = '<p class="text-gray-500 text-center">Inicia sesión para ver tus presupuestos.</p>';
                        totalExpensesDisplay.textContent = '€0.00';
                        totalIncomeDisplay.textContent = '€0.00';
                        balanceDisplay.textContent = '€0.00';
                        upcomingItemsList.innerHTML = '<p class="text-gray-500 text-center">Inicia sesión para ver tus próximos pagos/cobros.</p>';
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                userIdDisplay.textContent = 'Error al cargar ID';
                authMessage.textContent = `Error de Firebase: ${error.message}`;
                authMessage.classList.remove('hidden');
            }
        };

        // --- Authentication Functions ---
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authMessage.classList.add('hidden'); // Hide previous messages

            try {
                if (isLoginMode) {
                    // Login
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    // Register
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Auth error:", error.code, error.message);
                let userFriendlyMessage = "Ha ocurrido un error. Por favor, inténtalo de nuevo.";
                if (error.code === 'auth/invalid-email') {
                    userFriendlyMessage = "Formato de email inválido.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    userFriendlyMessage = "Email o contraseña incorrectos.";
                } else if (error.code === 'auth/email-already-in-use') {
                    userFriendlyMessage = "Este email ya está registrado. Intenta iniciar sesión.";
                } else if (error.code === 'auth/weak-password') {
                    userFriendlyMessage = "La contraseña debe tener al menos 6 caracteres.";
                }
                authMessage.textContent = userFriendlyMessage;
                authMessage.classList.remove('hidden');
            }
        });

        toggleAuthModeBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                authTitle.textContent = "Iniciar Sesión";
                authSubmitBtn.textContent = "Iniciar Sesión";
                toggleAuthModeBtn.textContent = "¿No tienes cuenta? Regístrate aquí";
            } else {
                authTitle.textContent = "Registrarse";
                authSubmitBtn.textContent = "Registrarse";
                toggleAuthModeBtn.textContent = "¿Ya tienes cuenta? Inicia sesión aquí";
            }
            authMessage.classList.add('hidden'); // Clear message on mode change
            authForm.reset();
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("Sesión cerrada.");
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
            }
        });

        // --- Generic Data Handling Functions (Firestore) ---
        const addDocument = async (collectionName, data) => {
            if (!userId) { console.error("No user authenticated."); return; }
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`), { ...data, createdAt: new Date().toISOString() });
                console.log(`${collectionName} añadido con éxito.`);
            } catch (e) { console.error(`Error al añadir ${collectionName}: `, e); }
        };

        const deleteDocument = async (collectionName, id) => {
            if (!userId) { console.error("No user authenticated."); return; }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, id));
                console.log(`${collectionName} eliminado con éxito.`);
            } catch (e) { console.error(`Error al eliminar ${collectionName}: `, e); }
        };

        const updateDocument = async (collectionName, id, updatedData) => {
            if (!userId) { console.error("No user authenticated."); return; }
            try {
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, id), updatedData);
                console.log(`${collectionName} actualizado con éxito.`);
            } catch (e) { console.error(`Error al actualizar ${collectionName}: `, e); }
        };

        // --- Balance Update Function ---
        /**
         * Updates the overall balance.
         */
        const updateBalance = () => {
            const totalExp = parseFloat(totalExpensesDisplay.textContent.replace('€', ''));
            const totalInc = parseFloat(totalIncomeDisplay.textContent.replace('€', ''));
            const balance = totalInc - totalExp;
            balanceDisplay.textContent = `€${balance.toFixed(2)}`;
            if (balance < 0) {
                balanceDisplay.classList.remove('text-green-700');
                balanceDisplay.classList.add('text-red-700');
            } else {
                balanceDisplay.classList.remove('text-red-700');
                balanceDisplay.classList.add('text-green-700');
            }
        };

        // --- Specific Data Listeners and Renderers ---

        const listenForExpenses = () => {
            if (!userId) return;
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/expenses`), (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderExpenses(allExpenses);
                updateUpcomingItems();
                renderBudgets(); // Update budgets display when expenses change
            }, (error) => { console.error("Error al escuchar gastos:", error); });
        };

        const listenForIncomes = () => {
            if (!userId) return;
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/incomes`), (snapshot) => {
                allIncomes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderIncomes(allIncomes);
                updateUpcomingItems();
            }, (error) => { console.error("Error al escuchar ingresos:", error); });
        };

        const listenForProjects = () => {
            if (!userId) return;
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/projects`), (snapshot) => {
                allProjects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProjects();
                populateProjectSelects(); // Update project dropdowns
            }, (error) => { console.error("Error al escuchar proyectos:", error); });
        };

        const listenForBudgets = () => {
            if (!userId) return;
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/budgets`), (snapshot) => {
                allBudgets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderBudgets(); // Render budgets when they change
            }, (error) => { console.error("Error al escuchar presupuestos:", error); });
        };

        // --- Rendering Functions ---

        const renderExpenses = (expenses) => {
            let filteredExpenses = [...expenses];
            // Apply filters
            const categoryFilter = filterExpenseCategory.value;
            if (categoryFilter) filteredExpenses = filteredExpenses.filter(exp => exp.category === categoryFilter);
            const dateFilter = filterExpenseDate.value;
            if (dateFilter) filteredExpenses = filteredExpenses.filter(exp => exp.date === dateFilter);
            const searchQuery = searchExpense.value.toLowerCase();
            if (searchQuery) filteredExpenses = filteredExpenses.filter(exp => exp.description.toLowerCase().includes(searchQuery) || exp.category.toLowerCase().includes(searchQuery));

            filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

            expensesList.innerHTML = '';
            let total = 0;
            if (filteredExpenses.length === 0) {
                noExpensesMessage.classList.remove('hidden');
            } else {
                noExpensesMessage.classList.add('hidden');
                filteredExpenses.forEach(expense => {
                    total += expense.amount;
                    const projectName = allProjects.find(p => p.id === expense.project)?.name || 'N/A';
                    const expenseItem = document.createElement('div');
                    expenseItem.className = 'bg-gray-50 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
                    expenseItem.innerHTML = `
                        <div class="flex-grow mb-2 sm:mb-0">
                            <p class="text-lg font-semibold text-gray-800">${expense.description}</p>
                            <p class="text-sm text-gray-600">Categoría: <span class="font-medium">${expense.category}</span> | Fecha: <span class="font-medium">${new Date(expense.date).toLocaleDateString('es-ES')}</span></p>
                            <p class="text-xs text-gray-500">Frecuencia: ${expense.frequency || 'Momentáneo'} | Proyecto: ${projectName}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <p class="text-xl font-bold text-red-600">€${expense.amount.toFixed(2)}</p>
                            <button class="btn-secondary px-3 py-1 text-sm edit-btn" data-id="${expense.id}" data-type="expenses">Editar</button>
                            <button class="btn-danger px-3 py-1 text-sm delete-btn" data-id="${expense.id}" data-type="expenses">Eliminar</button>
                        </div>
                    `;
                    expensesList.appendChild(expenseItem);
                });
            }
            totalExpensesDisplay.textContent = `€${total.toFixed(2)}`;
            updateBalance();
        };

        const renderIncomes = (incomes) => {
            let filteredIncomes = [...incomes];
            // Apply filters
            const categoryFilter = filterIncomeCategory.value;
            if (categoryFilter) filteredIncomes = filteredIncomes.filter(inc => inc.category === categoryFilter);
            const dateFilter = filterIncomeDate.value;
            if (dateFilter) filteredIncomes = filteredIncomes.filter(inc => inc.date === dateFilter);
            const searchQuery = searchIncome.value.toLowerCase();
            if (searchQuery) filteredIncomes = filteredIncomes.filter(inc => inc.description.toLowerCase().includes(searchQuery) || inc.category.toLowerCase().includes(searchQuery));

            filteredIncomes.sort((a, b) => new Date(b.date) - new Date(a.date));

            incomeList.innerHTML = '';
            let total = 0;
            if (filteredIncomes.length === 0) {
                noIncomeMessage.classList.remove('hidden');
            } else {
                noIncomeMessage.classList.add('hidden');
                filteredIncomes.forEach(income => {
                    total += income.amount;
                    const projectName = allProjects.find(p => p.id === income.project)?.name || 'N/A';
                    const incomeItem = document.createElement('div');
                    incomeItem.className = 'bg-gray-50 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
                    incomeItem.innerHTML = `
                        <div class="flex-grow mb-2 sm:mb-0">
                            <p class="text-lg font-semibold text-gray-800">${income.description}</p>
                            <p class="text-sm text-gray-600">Categoría: <span class="font-medium">${income.category}</span> | Fecha: <span class="font-medium">${new Date(income.date).toLocaleDateString('es-ES')}</span></p>
                            <p class="text-xs text-gray-500">Frecuencia: ${income.frequency || 'Momentáneo'} | Proyecto: ${projectName}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <p class="text-xl font-bold text-green-600">€${income.amount.toFixed(2)}</p>
                            <button class="btn-secondary px-3 py-1 text-sm edit-btn" data-id="${income.id}" data-type="incomes">Editar</button>
                            <button class="btn-danger px-3 py-1 text-sm delete-btn" data-id="${income.id}" data-type="incomes">Eliminar</button>
                        </div>
                    `;
                    incomeList.appendChild(incomeItem);
                });
            }
            totalIncomeDisplay.textContent = `€${total.toFixed(2)}`;
            updateBalance();
        };

        const renderProjects = () => {
            projectsList.innerHTML = '';
            if (allProjects.length === 0) {
                noProjectsMessage.classList.remove('hidden');
            } else {
                noProjectsMessage.classList.add('hidden');
                allProjects.forEach(project => {
                    const projectExpenses = allExpenses.filter(exp => exp.project === project.id).reduce((sum, exp) => sum + exp.amount, 0);
                    const projectIncomes = allIncomes.filter(inc => inc.project === project.id).reduce((sum, inc) => sum + inc.amount, 0);
                    const projectBalance = projectIncomes - projectExpenses;

                    const projectItem = document.createElement('div');
                    projectItem.className = 'bg-blue-50 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center shadow-sm';
                    projectItem.innerHTML = `
                        <div class="flex-grow mb-2 sm:mb-0">
                            <p class="text-lg font-semibold text-blue-800">${project.name}</p>
                            <p class="text-sm text-blue-700">Presupuesto Estimado: €${project.budget ? parseFloat(project.budget).toFixed(2) : 'N/A'}</p>
                            <p class="text-sm text-blue-700">Gastos Totales: <span class="font-bold text-red-600">€${projectExpenses.toFixed(2)}</span></p>
                            <p class="text-sm text-blue-700">Ingresos Totales: <span class="font-bold text-green-600">€${projectIncomes.toFixed(2)}</span></p>
                            <p class="text-sm text-blue-700">Balance: <span class="font-bold ${projectBalance < 0 ? 'text-red-600' : 'text-green-600'}">€${projectBalance.toFixed(2)}</span></p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button class="btn-secondary px-3 py-1 text-sm edit-btn" data-id="${project.id}" data-type="projects">Editar</button>
                            <button class="btn-danger px-3 py-1 text-sm delete-btn" data-id="${project.id}" data-type="projects">Eliminar</button>
                        </div>
                    `;
                    projectsList.appendChild(projectItem);
                });
            }
        };

        const renderBudgets = () => {
            budgetsList.innerHTML = '';
            if (allBudgets.length === 0) {
                noBudgetsMessage.classList.remove('hidden');
            } else {
                noBudgetsMessage.classList.add('hidden');
                const currentMonth = new Date().toISOString().slice(0, 7); //YYYY-MM
                const expensesThisMonthByCategory = {};

                allExpenses.forEach(exp => {
                    const expenseMonth = exp.date.slice(0, 7);
                    if (expenseMonth === currentMonth) {
                        if (!expensesThisMonthByCategory[exp.category]) {
                            expensesThisMonthByCategory[exp.category] = 0;
                        }
                        expensesThisMonthByCategory[exp.category] += exp.amount;
                    }
                });

                allBudgets.forEach(budget => {
                    const spent = expensesThisMonthByCategory[budget.category] || 0;
                    const percentage = (spent / budget.amount) * 100;
                    const isOverBudget = percentage > 100;

                    const budgetItem = document.createElement('div');
                    budgetItem.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                    budgetItem.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-lg font-semibold text-gray-800">${budget.category}</p>
                            <div class="flex items-center space-x-2">
                                <p class="text-sm text-gray-600">Presupuesto: <span class="font-bold">€${parseFloat(budget.amount).toFixed(2)}</span></p>
                                <button class="btn-secondary px-2 py-0.5 text-xs edit-btn" data-id="${budget.id}" data-type="budgets">Editar</button>
                                <button class="btn-danger px-2 py-0.5 text-xs delete-btn" data-id="${budget.id}" data-type="budgets">Eliminar</button>
                            </div>
                        </div>
                        <div class="budget-bar-container">
                            <div class="budget-bar-fill ${isOverBudget ? 'over-budget' : ''}" style="width: ${Math.min(percentage, 100)}%;"></div>
                        </div>
                        <p class="budget-text text-gray-700">Gastado este mes: <span class="font-bold">€${spent.toFixed(2)}</span> (${percentage.toFixed(1)}%)</p>
                        ${isOverBudget ? '<p class="text-red-500 font-semibold text-sm mt-1">¡Presupuesto excedido!</p>' : ''}
                    `;
                    budgetsList.appendChild(budgetItem);
                });
            }
        };

        // --- Project Select Population ---
        const populateProjectSelects = () => {
            const projectSelects = [expenseProjectSelect, incomeProjectSelect, editProjectSelect];
            projectSelects.forEach(select => {
                const currentSelected = select.value;
                select.innerHTML = '<option value="">Ninguno</option>'; // Always keep "Ninguno" option
                allProjects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
                // Restore selection if the project still exists
                if (Array.from(select.options).some(option => option.value === currentSelected)) {
                    select.value = currentSelected;
                } else {
                    select.value = ''; // Default to "Ninguno" if old project is gone
                }
            });
        };

        // --- Upcoming Items Logic ---
        const calculateNextDueDate = (lastDateStr, frequency) => {
            const lastDate = new Date(lastDateStr + 'T00:00:00');
            const nextDate = new Date(lastDate);

            switch (frequency) {
                case 'Semanal': nextDate.setDate(lastDate.getDate() + 7); break;
                case 'Mensual': nextDate.setMonth(lastDate.getMonth() + 1); break;
                case 'Anual': nextDate.setFullYear(lastDate.getFullYear() + 1); break;
                default: return null;
            }
            return nextDate;
        };

        const updateUpcomingItems = () => {
            upcomingItemsList.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const sevenDaysFromNow = new Date();
            sevenDaysFromNow.setDate(today.getDate() + 7);
            sevenDaysFromNow.setHours(23, 59, 59, 999);

            let hasUpcoming = false;

            const processItem = (item, type) => {
                if (item.frequency !== 'Momentáneo' && item.date) {
                    let nextDueDate = calculateNextDueDate(item.date, item.frequency);

                    // If the original nextDueDate is in the past, calculate future occurrences
                    while (nextDueDate && nextDueDate < today) {
                        if (item.frequency === 'Semanal') {
                            nextDueDate.setDate(nextDueDate.getDate() + 7);
                        } else if (item.frequency === 'Mensual') {
                            nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                        } else if (item.frequency === 'Anual') {
                            nextDueDate.setFullYear(nextDueDate.getFullYear() + 1);
                        }
                    }

                    if (nextDueDate && nextDueDate >= today && nextDueDate <= sevenDaysFromNow) {
                        hasUpcoming = true;
                        const itemElement = document.createElement('div');
                        itemElement.className = `p-3 rounded-md flex justify-between items-center text-sm shadow-sm ${type === 'expenses' ? 'bg-yellow-50' : 'bg-green-50'}`;
                        const textColor = type === 'expenses' ? 'text-yellow-700' : 'text-green-700';
                        const amountColor = type === 'expenses' ? 'text-red-600' : 'text-green-600'; // Keep red for expenses, green for income

                        itemElement.innerHTML = `
                            <p class="font-medium ${textColor}">${type === 'expenses' ? 'Gasto' : 'Ingreso'}: ${item.description} (${item.category})</p>
                            <p class="${textColor}">Vence: ${nextDueDate.toLocaleDateString('es-ES')} (${item.frequency}) - <span class="font-bold ${amountColor}">€${item.amount.toFixed(2)}</span></p>
                        `;
                        upcomingItemsList.appendChild(itemElement);
                    }
                }
            };

            allExpenses.forEach(exp => processItem(exp, 'expenses'));
            allIncomes.forEach(inc => processItem(inc, 'incomes'));

            if (!hasUpcoming) {
                noUpcomingMessage.classList.remove('hidden');
            } else {
                noUpcomingMessage.classList.add('hidden');
            }
        };

        // --- Gemini API Integrations ---

        const getCategoryList = (type) => {
            if (type === 'expenses') {
                return Array.from(expenseCategorySelect.options).map(opt => opt.value).filter(val => val !== '');
            } else if (type === 'incomes') {
                return Array.from(incomeCategorySelect.options).map(opt => opt.value).filter(val => val !== '');
            }
            return [];
        };

        const suggestCategory = async () => {
            const description = expenseDescriptionInput.value.trim();
            if (!description) { console.warn("Por favor, introduce una descripción para sugerir una categoría."); return; }

            suggestCategoryBtn.disabled = true;
            suggestSpinner.classList.remove('hidden');
            const categories = getCategoryList('expenses');
            const prompt = `Dada la descripción del gasto: "${description}", sugiere la categoría más apropiada de la siguiente lista para un negocio inmobiliario: ${categories.join(', ')}. Responde ÚNICAMENTE con el nombre de la categoría sugerida.`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    let suggestedCategory = result.candidates[0].content.parts[0].text.trim().replace(/```/g, '').replace(/\n/g, '').trim();
                    if (categories.includes(suggestedCategory)) {
                        expenseCategorySelect.value = suggestedCategory;
                    } else {
                        const matchedCategory = categories.find(cat => suggestedCategory.includes(cat));
                        if (matchedCategory) { expenseCategorySelect.value = matchedCategory; } else { expenseCategorySelect.value = "Otros"; console.warn(`Categoría sugerida "${suggestedCategory}" no encontrada. Se seleccionó "Otros".`); }
                    }
                } else { console.error("No se pudo obtener una sugerencia de categoría."); expenseCategorySelect.value = "Otros"; }
            } catch (error) { console.error("Error al sugerir categoría:", error); expenseCategorySelect.value = "Otros"; }
            finally { suggestCategoryBtn.disabled = false; suggestSpinner.classList.add('hidden'); }
        };

        const generateExpenseAnalysis = async () => {
            if (allExpenses.length === 0) { analysisContent.textContent = "No hay gastos registrados para generar un análisis."; analysisModal.style.display = 'flex'; return; }

            analyzeExpensesBtn.disabled = true;
            analyzeSpinner.classList.remove('hidden');
            analysisContent.textContent = "Cargando análisis...";
            analysisModal.style.display = 'flex';

            const formattedExpenses = allExpenses.map(exp => `- ${exp.date}: ${exp.description} (${exp.category}, Frecuencia: ${exp.frequency || 'Momentáneo'}) - €${exp.amount.toFixed(2)}`).join('\n');
            const prompt = `Aquí están mis gastos recientes relacionados con el sector inmobiliario de FabricandoHogares:\n${formattedExpenses}\n\nPor favor, proporciona un análisis conciso de mis hábitos de gasto, identifica cualquier tendencia notable (especialmente con la frecuencia de los gastos y categorías inmobiliarias específicas) y sugiere posibles áreas para ahorrar o mejorar la eficiencia. Enfócate en ideas accionables relevantes para un negocio inmobiliario.`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    analysisContent.textContent = result.candidates[0].content.parts[0].text;
                } else { analysisContent.textContent = "No se pudo generar el análisis. Inténtalo de nuevo más tarde."; console.error("No se pudo obtener el análisis de gastos."); }
            } catch (error) { analysisContent.textContent = "Error al generar el análisis. Asegúrate de tener conexión a internet."; console.error("Error al generar análisis de gastos:", error); }
            finally { analyzeExpensesBtn.disabled = false; analyzeSpinner.classList.add('hidden'); }
        };

        const showCategoryAnalysis = () => {
            if (allExpenses.length === 0) { categoryAnalysisContent.innerHTML = "<p class='text-center'>No hay gastos para analizar por categoría.</p>"; categoryAnalysisModal.style.display = 'flex'; return; }

            const expensesByCategory = {};
            allExpenses.forEach(exp => {
                if (!expensesByCategory[exp.category]) expensesByCategory[exp.category] = 0;
                expensesByCategory[exp.category] += exp.amount;
            });

            let html = '<h3 class="text-lg font-semibold mb-2">Gastos por Categoría:</h3>';
            html += '<div class="bar-chart-container">';
            const maxAmount = Math.max(...Object.values(expensesByCategory));

            Object.keys(expensesByCategory).sort().forEach(category => {
                const percentage = (expensesByCategory[category] / maxAmount) * 100;
                html += `
                    <div class="bar-item">
                        <span class="bar-label">${category}:</span>
                        <div class="bar-fill" style="width: ${percentage.toFixed(1)}%;"></div>
                        <span class="bar-value">€${expensesByCategory[category].toFixed(2)}</span>
                    </div>
                `;
            });
            html += '</div>';
            categoryAnalysisContent.innerHTML = html;
            categoryAnalysisModal.style.display = 'flex';
        };

        const showMonthlyAnalysis = () => {
            if (allExpenses.length === 0) { monthlyAnalysisContent.innerHTML = "<p class='text-center'>No hay gastos para analizar mensualmente.</p>"; monthlyAnalysisModal.style.display = 'flex'; return; }

            const expensesByMonth = {};
            allExpenses.forEach(exp => {
                const date = new Date(exp.date);
                const yearMonth = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                if (!expensesByMonth[yearMonth]) expensesByMonth[yearMonth] = 0;
                expensesByMonth[yearMonth] += exp.amount;
            });

            const sortedMonths = Object.keys(expensesByMonth).sort();
            const maxAmount = Math.max(...Object.values(expensesByMonth));

            let html = '<h3 class="text-lg font-semibold mb-2">Gastos por Mes:</h3>';
            html += '<div class="bar-chart-container">';
            sortedMonths.forEach(month => {
                const percentage = (expensesByMonth[month] / maxAmount) * 100;
                html += `
                    <div class="bar-item">
                        <span class="bar-label">${month}:</span>
                        <div class="bar-fill" style="width: ${percentage.toFixed(1)}%;"></div>
                        <span class="bar-value">€${expensesByMonth[month].toFixed(2)}</span>
                    </div>
                `;
            });
            html += '</div>';
            monthlyAnalysisContent.innerHTML = html;
            monthlyAnalysisModal.style.display = 'flex';
        };


        // --- Event Listeners ---

        // Main Tab Switching
        tabTransactions.addEventListener('click', () => switchMainTab('transactions'));
        tabProjects.addEventListener('click', () => switchMainTab('projects'));
        tabBudgets.addEventListener('click', () => switchMainTab('budgets'));

        const switchMainTab = (activeTab) => {
            const tabs = {
                transactions: transactionsSection,
                projects: projectsSection,
                budgets: budgetsSection
            };
            const buttons = {
                transactions: tabTransactions,
                projects: tabProjects,
                budgets: tabBudgets
            };

            for (const tab in tabs) {
                if (tab === activeTab) {
                    tabs[tab].classList.remove('hidden');
                    buttons[tab].classList.add('bg-indigo-600', 'text-white');
                    buttons[tab].classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    tabs[tab].classList.add('hidden');
                    buttons[tab].classList.remove('bg-indigo-600', 'text-white');
                    buttons[tab].classList.add('bg-gray-200', 'text-gray-700');
                }
            }
        };

        // Sub-tab Switching for Transactions
        subTabExpenses.addEventListener('click', () => switchSubTab('expenses'));
        subTabIncome.addEventListener('click', () => switchSubTab('income'));

        const switchSubTab = (activeSubTab) => {
            const contents = {
                expenses: expenseContent,
                income: incomeContent
            };
            const buttons = {
                expenses: subTabExpenses,
                income: subTabIncome
            };

            for (const subTab in contents) {
                if (subTab === activeSubTab) {
                    contents[subTab].classList.remove('hidden');
                    buttons[subTab].classList.add('bg-indigo-600', 'text-white');
                    buttons[subTab].classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    contents[subTab].classList.add('hidden');
                    buttons[subTab].classList.remove('bg-indigo-600', 'text-white');
                    buttons[subTab].classList.add('bg-gray-200', 'text-gray-700');
                }
            }
        };


        // Forms Submissions
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = expenseDescriptionInput.value;
            const amount = document.getElementById('expenseAmount').value;
            const date = document.getElementById('expenseDate').value;
            const category = expenseCategorySelect.value;
            const frequency = expenseFrequencySelect.value;
            const project = expenseProjectSelect.value;

            if (description && amount && date && category && frequency) {
                await addDocument('expenses', { description, amount: parseFloat(amount), date, category, frequency, project });
                expenseForm.reset();
            } else { console.warn("Por favor, rellena todos los campos del gasto."); }
        });

        incomeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = document.getElementById('incomeDescription').value;
            const amount = document.getElementById('incomeAmount').value;
            const date = document.getElementById('incomeDate').value;
            const category = document.getElementById('incomeCategory').value;
            const frequency = incomeFrequencySelect.value;
            const project = incomeProjectSelect.value;

            if (description && amount && date && category && frequency) {
                await addDocument('incomes', { description, amount: parseFloat(amount), date, category, frequency, project });
                incomeForm.reset();
            } else { console.warn("Por favor, rellena todos los campos del ingreso."); }
        });

        projectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = projectNameInput.value;
            const budget = projectBudgetInput.value;
            if (name) {
                await addDocument('projects', { name, budget: parseFloat(budget) || 0 });
                projectForm.reset();
            } else { console.warn("Por favor, introduce el nombre del proyecto."); }
        });

        budgetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = budgetCategorySelect.value;
            const amount = budgetAmountInput.value;
            if (category && amount) {
                // Check if budget for this category already exists
                const existingBudget = allBudgets.find(b => b.category === category);
                if (existingBudget) {
                    await updateDocument('budgets', existingBudget.id, { amount: parseFloat(amount) });
                } else {
                    await addDocument('budgets', { category, amount: parseFloat(amount) });
                }
                budgetForm.reset();
            } else { console.warn("Por favor, selecciona una categoría y un monto para el presupuesto."); }
        });


        // Delegated event listener for delete and edit buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const id = e.target.dataset.id;
                const type = e.target.dataset.type; // 'expenses', 'incomes', 'projects', 'budgets'
                itemToDelete = { id, type };
                confirmationModal.style.display = 'flex';
            } else if (e.target.classList.contains('edit-btn')) {
                const id = e.target.dataset.id;
                const type = e.target.dataset.type; // 'expenses', 'incomes', 'projects', 'budgets'
                openEditModal(id, type);
            }
        });

        // Confirmation Modal Buttons
        closeConfirmationModal.addEventListener('click', () => { confirmationModal.style.display = 'none'; itemToDelete = null; });
        cancelDeleteBtn.addEventListener('click', () => { confirmationModal.style.display = 'none'; itemToDelete = null; });
        confirmDeleteBtn.addEventListener('click', async () => {
            if (itemToDelete) {
                await deleteDocument(itemToDelete.type, itemToDelete.id);
                confirmationModal.style.display = 'none';
                itemToDelete = null;
            }
        });

        // Edit Modal Logic
        closeEditModal.addEventListener('click', () => { editModal.style.display = 'none'; });

        const openEditModal = async (id, type) => {
            if (!userId) { console.error("No user authenticated. Cannot open edit modal."); return; }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${type}`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    editIdInput.value = id;
                    editTypeInput.value = type;

                    // Populate common fields
                    editDescriptionInput.value = data.description || '';
                    editAmountInput.value = data.amount || data.budget || ''; // For budgets, use 'budget' field
                    editDateInput.value = data.date || '';
                    editFrequencySelect.value = data.frequency || 'Momentáneo';
                    editProjectSelect.value = data.project || '';

                    // Show/hide fields based on type
                    const fieldsToShowHide = {
                        description: document.querySelector('label[for="editDescription"]').parentElement,
                        amount: document.querySelector('label[for="editAmount"]').parentElement,
                        date: document.querySelector('label[for="editDate"]').parentElement,
                        category: document.querySelector('label[for="editCategory"]').parentElement,
                        frequency: document.querySelector('label[for="editFrequency"]').parentElement,
                        project: document.querySelector('label[for="editProject"]').parentElement
                    };

                    // Hide all first
                    Object.values(fieldsToShowHide).forEach(el => el.classList.add('hidden'));

                    if (type === 'expenses' || type === 'incomes') {
                        fieldsToShowHide.description.classList.remove('hidden');
                        fieldsToShowHide.amount.classList.remove('hidden');
                        fieldsToShowHide.date.classList.remove('hidden');
                        fieldsToShowHide.category.classList.remove('hidden');
                        fieldsToShowHide.frequency.classList.remove('hidden');
                        fieldsToShowHide.project.classList.remove('hidden');

                        editCategorySelect.innerHTML = '';
                        let categories = [];
                        if (type === 'expenses') {
                            categories = ["Material de Oficina", "Suministros", "Transporte", "Comidas", "Alquiler", "Servicios Profesionales", "Marketing", "Software/Suscripciones", "Comisiones", "Reformas/Mantenimiento", "Impuestos Propiedad", "Seguros Inmobiliarios", "Publicidad Inmobiliaria", "Otros"];
                        } else {
                            categories = ["Ventas de Propiedades", "Alquileres", "Comisiones Ventas", "Comisiones Alquiler", "Servicios de Gestión", "Otros Ingresos Inmobiliarios"];
                        }
                        categories.forEach(cat => { const option = document.createElement('option'); option.value = cat; option.textContent = cat; editCategorySelect.appendChild(option); });
                        editCategorySelect.value = data.category;
                        populateProjectSelects(); // Re-populate for edit form
                        editProjectSelect.value = data.project || '';

                    } else if (type === 'projects') {
                        fieldsToShowHide.description.classList.remove('hidden'); // Re-use description for project name
                        document.querySelector('label[for="editDescription"]').textContent = 'Nombre del Proyecto/Propiedad';
                        fieldsToShowHide.amount.classList.remove('hidden'); // Re-use amount for project budget
                        document.querySelector('label[for="editAmount"]').textContent = 'Presupuesto Estimado (€)';

                        editDescriptionInput.value = data.name || '';
                        editAmountInput.value = data.budget || 0;

                    } else if (type === 'budgets') {
                        fieldsToShowHide.category.classList.remove('hidden');
                        fieldsToShowHide.amount.classList.remove('hidden'); // Re-use amount for budget amount
                        document.querySelector('label[for="editAmount"]').textContent = 'Presupuesto Mensual (€)';

                        editCategorySelect.innerHTML = ''; // Populate with expense categories
                        const expenseCategories = ["Material de Oficina", "Suministros", "Transporte", "Comidas", "Alquiler", "Servicios Profesionales", "Marketing", "Software/Suscripciones", "Comisiones", "Reformas/Mantenimiento", "Impuestos Propiedad", "Seguros Inmobiliarios", "Publicidad Inmobiliaria", "Otros"];
                        expenseCategories.forEach(cat => { const option = document.createElement('option'); option.value = cat; option.textContent = cat; editCategorySelect.appendChild(option); });
                        editCategorySelect.value = data.category;
                        editAmountInput.value = data.amount || 0;
                    }

                    editModal.style.display = 'flex';
                } else { console.error("No such document!"); }
            } catch (error) { console.error("Error fetching document for edit:", error); }
        };

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editIdInput.value;
            const type = editTypeInput.value;
            let updatedData = {};

            if (type === 'expenses' || type === 'incomes') {
                updatedData = {
                    description: editDescriptionInput.value,
                    amount: parseFloat(editAmountInput.value),
                    date: editDateInput.value,
                    category: editCategorySelect.value,
                    frequency: editFrequencySelect.value,
                    project: editProjectSelect.value || ''
                };
            } else if (type === 'projects') {
                updatedData = {
                    name: editDescriptionInput.value,
                    budget: parseFloat(editAmountInput.value) || 0
                };
            } else if (type === 'budgets') {
                updatedData = {
                    category: editCategorySelect.value,
                    amount: parseFloat(editAmountInput.value) || 0
                };
            }
            await updateDocument(type, id, updatedData);
            editModal.style.display = 'none';
            // Restore labels to default after edit if needed for expense/income fields
            document.querySelector('label[for="editDescription"]').textContent = 'Descripción';
            document.querySelector('label[for="editAmount"]').textContent = 'Importe (€)';
        });


        // Filter and Search Event Listeners
        filterExpenseCategory.addEventListener('change', () => renderExpenses(allExpenses));
        filterExpenseDate.addEventListener('change', () => renderExpenses(allExpenses));
        searchExpense.addEventListener('input', () => renderExpenses(allExpenses));

        filterIncomeCategory.addEventListener('change', () => renderIncomes(allIncomes));
        filterIncomeDate.addEventListener('change', () => renderIncomes(allIncomes));
        searchIncome.addEventListener('input', () => renderIncomes(allIncomes));


        // Gemini API button listeners
        suggestCategoryBtn.addEventListener('click', suggestCategory);
        analyzeExpensesBtn.addEventListener('click', generateExpenseAnalysis);

        // Analysis Modal close buttons
        closeAnalysisModal.addEventListener('click', () => { analysisModal.style.display = 'none'; });
        closeAnalysisModalBtn.addEventListener('click', () => { analysisModal.style.display = 'none'; });

        // Category Analysis Modal buttons
        showCategoryAnalysisBtn.addEventListener('click', showCategoryAnalysis);
        closeCategoryAnalysisModal.addEventListener('click', () => { categoryAnalysisModal.style.display = 'none'; });
        closeCategoryAnalysisModalBtn.addEventListener('click', () => { categoryAnalysisModal.style.display = 'none'; });

        // Monthly Analysis Modal buttons
        showMonthlyAnalysisBtn.addEventListener('click', showMonthlyAnalysis);
        closeMonthlyAnalysisModal.addEventListener('click', () => { monthlyAnalysisModal.style.display = 'none'; });
        closeMonthlyAnalysisModalBtn.addEventListener('click', () => { monthlyAnalysisModal.style.display = 'none'; });

        // Initialize Firebase on window load
        window.onload = initializeFirebase;
    </script>
</body>
</html>
